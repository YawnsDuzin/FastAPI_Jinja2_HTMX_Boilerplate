# 03. 데이터베이스 모델

## 3.1 개요

이 프로젝트는 **SQLAlchemy 2.0+** ORM을 사용하여 데이터베이스를 관리합니다. 비동기 작업을 위해 `aiosqlite` 드라이버를 사용합니다.

### 관련 파일

- `app/database.py` - 데이터베이스 연결 설정
- `app/models/base.py` - 기본 모델 클래스
- `app/models/user.py` - 사용자 모델
- `app/models/item.py` - 아이템 모델

---

## 3.2 데이터베이스 설정 (app/database.py)

### 3.2.1 비동기 엔진 생성

```python
from sqlalchemy.ext.asyncio import (
    AsyncSession,
    async_sessionmaker,
    create_async_engine,
)
from sqlalchemy.orm import DeclarativeBase

from app.config import settings


class Base(DeclarativeBase):
    """SQLAlchemy 모델 베이스 클래스"""
    pass


# 비동기 엔진 생성
engine = create_async_engine(
    settings.database_url,      # sqlite+aiosqlite:///./app.db
    echo=settings.debug,        # SQL 쿼리 로깅
    future=True,                # SQLAlchemy 2.0 스타일
)
```

#### 연결 문자열 형식

| 데이터베이스 | 연결 문자열 |
|--------------|-------------|
| SQLite (개발) | `sqlite+aiosqlite:///./app.db` |
| PostgreSQL (프로덕션) | `postgresql+asyncpg://user:pass@host:5432/db` |

---

### 3.2.2 비동기 세션 팩토리

```python
# 비동기 세션 팩토리
async_session_maker = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False,  # 커밋 후에도 객체 접근 가능
    autocommit=False,        # 자동 커밋 비활성화
    autoflush=False,         # 자동 플러시 비활성화
)
```

#### 주요 옵션

| 옵션 | 값 | 설명 |
|------|-----|------|
| `expire_on_commit` | `False` | 커밋 후에도 객체 속성에 접근 가능 |
| `autocommit` | `False` | 명시적 커밋 필요 |
| `autoflush` | `False` | 명시적 플러시 필요 |

---

### 3.2.3 세션 의존성 함수

```python
async def get_db() -> AsyncGenerator[AsyncSession, None]:
    """
    데이터베이스 세션 의존성

    FastAPI의 Depends를 통해 사용되며,
    요청 종료 시 자동으로 세션을 정리합니다.
    """
    async with async_session_maker() as session:
        try:
            yield session
            await session.commit()  # 성공 시 커밋
        except Exception:
            await session.rollback()  # 실패 시 롤백
            raise
        finally:
            await session.close()   # 세션 종료
```

#### 세션 생명주기

```
요청 시작
    │
    ▼
┌─────────────────────────────────┐
│ async_session_maker() 호출     │
│ → AsyncSession 생성             │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ yield session                   │  ← 요청 처리
│ (라우터에서 DB 작업 수행)       │
└─────────────────────────────────┘
    │
    ├── 성공 ──► commit()
    │
    └── 실패 ──► rollback()
    │
    ▼
┌─────────────────────────────────┐
│ session.close()                 │  ← 세션 종료
└─────────────────────────────────┘
```

---

### 3.2.4 DB 초기화/종료 함수

```python
async def init_db() -> None:
    """데이터베이스 테이블 초기화 (개발용)"""
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)


async def close_db() -> None:
    """데이터베이스 연결 종료"""
    await engine.dispose()
```

> **참고**: 프로덕션 환경에서는 Alembic 마이그레이션을 사용해야 합니다.

---

## 3.3 기본 모델 클래스 (app/models/base.py)

### 3.3.1 TimestampMixin

```python
from datetime import datetime
from sqlalchemy import DateTime, func
from sqlalchemy.orm import Mapped, mapped_column


class TimestampMixin:
    """생성/수정 시간 자동 관리 믹스인"""

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),  # DB 서버 시간 사용
        nullable=False,
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
        onupdate=func.now(),        # 업데이트 시 자동 갱신
        nullable=False,
    )
```

#### 자동 타임스탬프

| 컬럼 | 생성 시 | 수정 시 |
|------|---------|---------|
| `created_at` | 현재 시간 설정 | 변경 없음 |
| `updated_at` | 현재 시간 설정 | 현재 시간으로 갱신 |

---

### 3.3.2 BaseModel

```python
class BaseModel(Base, TimestampMixin):
    """
    모든 모델의 기본 클래스

    자동으로 ID, 생성시간, 수정시간을 포함합니다.
    """

    __abstract__ = True  # 테이블 생성하지 않음

    id: Mapped[int] = mapped_column(
        primary_key=True,
        autoincrement=True
    )

    def to_dict(self) -> dict[str, Any]:
        """모델을 딕셔너리로 변환"""
        return {
            column.name: getattr(self, column.name)
            for column in self.__table__.columns
        }

    def __repr__(self) -> str:
        """모델의 문자열 표현"""
        return f"<{self.__class__.__name__}(id={self.id})>"
```

#### BaseModel 구조

```
┌─────────────────────────────────────────────────────────────┐
│                        BaseModel                            │
├─────────────────────────────────────────────────────────────┤
│ id: int              │ Primary Key, Auto Increment         │
│ created_at: datetime │ 생성 시간 (자동)                    │
│ updated_at: datetime │ 수정 시간 (자동)                    │
├─────────────────────────────────────────────────────────────┤
│ to_dict() → dict     │ 딕셔너리 변환 메서드                │
│ __repr__() → str     │ 문자열 표현                         │
└─────────────────────────────────────────────────────────────┘
                        │
                        │ 상속
                        ▼
        ┌───────────────┴───────────────┐
        │                               │
┌───────▼───────┐               ┌───────▼───────┐
│     User      │               │     Item      │
└───────────────┘               └───────────────┘
```

---

## 3.4 User 모델 (app/models/user.py)

```python
from typing import TYPE_CHECKING, List, Optional
from sqlalchemy import Boolean, String
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.models.base import BaseModel

if TYPE_CHECKING:
    from app.models.item import Item


class User(BaseModel):
    """사용자 모델"""

    __tablename__ = "users"

    # 기본 정보
    email: Mapped[str] = mapped_column(
        String(255),
        unique=True,    # 이메일 고유성
        index=True,     # 검색 최적화
        nullable=False,
    )
    username: Mapped[str] = mapped_column(
        String(50),
        unique=True,
        index=True,
        nullable=False,
    )
    hashed_password: Mapped[str] = mapped_column(
        String(255),
        nullable=False,
    )

    # 프로필 정보
    full_name: Mapped[Optional[str]] = mapped_column(
        String(100),
        nullable=True,
    )
    avatar_url: Mapped[Optional[str]] = mapped_column(
        String(500),
        nullable=True,
    )

    # 상태
    is_active: Mapped[bool] = mapped_column(
        Boolean,
        default=True,
        nullable=False,
    )
    is_superuser: Mapped[bool] = mapped_column(
        Boolean,
        default=False,
        nullable=False,
    )
    is_verified: Mapped[bool] = mapped_column(
        Boolean,
        default=False,
        nullable=False,
    )

    # 관계
    items: Mapped[List["Item"]] = relationship(
        "Item",
        back_populates="owner",
        cascade="all, delete-orphan",
    )

    def __repr__(self) -> str:
        return f"<User(id={self.id}, email={self.email})>"
```

### 3.4.1 User 테이블 스키마

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| `id` | INTEGER | PK, AUTO_INCREMENT | 기본 키 |
| `email` | VARCHAR(255) | UNIQUE, NOT NULL, INDEX | 이메일 |
| `username` | VARCHAR(50) | UNIQUE, NOT NULL, INDEX | 사용자명 |
| `hashed_password` | VARCHAR(255) | NOT NULL | 해시된 비밀번호 |
| `full_name` | VARCHAR(100) | NULLABLE | 전체 이름 |
| `avatar_url` | VARCHAR(500) | NULLABLE | 아바타 URL |
| `is_active` | BOOLEAN | DEFAULT TRUE | 계정 활성화 상태 |
| `is_superuser` | BOOLEAN | DEFAULT FALSE | 관리자 여부 |
| `is_verified` | BOOLEAN | DEFAULT FALSE | 이메일 인증 여부 |
| `created_at` | DATETIME | NOT NULL | 생성 시간 |
| `updated_at` | DATETIME | NOT NULL | 수정 시간 |

### 3.4.2 TYPE_CHECKING 패턴

```python
if TYPE_CHECKING:
    from app.models.item import Item
```

이 패턴은 **순환 import 방지**를 위해 사용됩니다:

- `TYPE_CHECKING`은 타입 검사 도구(mypy 등)에서만 `True`
- 런타임에는 `False`이므로 import가 실행되지 않음
- 타입 힌트에서는 문자열로 참조: `List["Item"]`

### 3.4.3 관계 설정

```python
items: Mapped[List["Item"]] = relationship(
    "Item",
    back_populates="owner",         # Item.owner와 양방향 연결
    cascade="all, delete-orphan",   # User 삭제 시 Item도 삭제
)
```

---

## 3.5 Item 모델 (app/models/item.py)

```python
from typing import TYPE_CHECKING, Optional
from sqlalchemy import Boolean, ForeignKey, Integer, String, Text
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.models.base import BaseModel

if TYPE_CHECKING:
    from app.models.user import User


class Item(BaseModel):
    """아이템 모델 (CRUD 예제)"""

    __tablename__ = "items"

    # 기본 정보
    title: Mapped[str] = mapped_column(
        String(200),
        nullable=False,
        index=True,
    )
    description: Mapped[Optional[str]] = mapped_column(
        Text,
        nullable=True,
    )

    # 상태
    is_active: Mapped[bool] = mapped_column(
        Boolean,
        default=True,
        nullable=False,
    )
    priority: Mapped[int] = mapped_column(
        Integer,
        default=0,
        nullable=False,
    )

    # 소유자 관계
    owner_id: Mapped[int] = mapped_column(
        ForeignKey("users.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    owner: Mapped["User"] = relationship(
        "User",
        back_populates="items",
    )

    def __repr__(self) -> str:
        return f"<Item(id={self.id}, title={self.title})>"
```

### 3.5.1 Item 테이블 스키마

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| `id` | INTEGER | PK, AUTO_INCREMENT | 기본 키 |
| `title` | VARCHAR(200) | NOT NULL, INDEX | 제목 |
| `description` | TEXT | NULLABLE | 설명 |
| `is_active` | BOOLEAN | DEFAULT TRUE | 활성화 상태 |
| `priority` | INTEGER | DEFAULT 0 | 우선순위 (0-10) |
| `owner_id` | INTEGER | FK(users.id), NOT NULL, INDEX | 소유자 |
| `created_at` | DATETIME | NOT NULL | 생성 시간 |
| `updated_at` | DATETIME | NOT NULL | 수정 시간 |

### 3.5.2 외래 키 설정

```python
owner_id: Mapped[int] = mapped_column(
    ForeignKey("users.id", ondelete="CASCADE"),
    nullable=False,
    index=True,
)
```

- `ForeignKey("users.id")`: users 테이블의 id 참조
- `ondelete="CASCADE"`: 사용자 삭제 시 아이템도 삭제
- `index=True`: 조회 성능 최적화

---

## 3.6 ER 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                             users                                   │
├─────────────────────────────────────────────────────────────────────┤
│ PK │ id           │ INTEGER      │ AUTO_INCREMENT                   │
├────┼──────────────┼──────────────┼──────────────────────────────────┤
│    │ email        │ VARCHAR(255) │ UNIQUE, NOT NULL                 │
│    │ username     │ VARCHAR(50)  │ UNIQUE, NOT NULL                 │
│    │ hashed_pass  │ VARCHAR(255) │ NOT NULL                         │
│    │ full_name    │ VARCHAR(100) │ NULLABLE                         │
│    │ avatar_url   │ VARCHAR(500) │ NULLABLE                         │
│    │ is_active    │ BOOLEAN      │ DEFAULT TRUE                     │
│    │ is_superuser │ BOOLEAN      │ DEFAULT FALSE                    │
│    │ is_verified  │ BOOLEAN      │ DEFAULT FALSE                    │
│    │ created_at   │ DATETIME     │ NOT NULL                         │
│    │ updated_at   │ DATETIME     │ NOT NULL                         │
└────┴──────────────┴──────────────┴──────────────────────────────────┘
                                    │
                                    │ 1:N 관계
                                    │
┌─────────────────────────────────────────────────────────────────────┐
│                             items                                   │
├─────────────────────────────────────────────────────────────────────┤
│ PK │ id           │ INTEGER      │ AUTO_INCREMENT                   │
├────┼──────────────┼──────────────┼──────────────────────────────────┤
│    │ title        │ VARCHAR(200) │ NOT NULL                         │
│    │ description  │ TEXT         │ NULLABLE                         │
│    │ is_active    │ BOOLEAN      │ DEFAULT TRUE                     │
│    │ priority     │ INTEGER      │ DEFAULT 0                        │
│ FK │ owner_id     │ INTEGER      │ REFERENCES users(id) CASCADE     │
│    │ created_at   │ DATETIME     │ NOT NULL                         │
│    │ updated_at   │ DATETIME     │ NOT NULL                         │
└────┴──────────────┴──────────────┴──────────────────────────────────┘
```

---

## 3.7 마이그레이션

### Alembic 명령어

```bash
# 마이그레이션 생성
alembic revision --autogenerate -m "설명"

# 마이그레이션 적용
alembic upgrade head

# 마이그레이션 롤백
alembic downgrade -1
```

### 마이그레이션 파일 위치

```
alembic/
├── env.py              # 환경 설정
├── script.py.mako      # 마이그레이션 템플릿
└── versions/           # 마이그레이션 스크립트
    ├── xxxx_initial.py
    └── yyyy_add_column.py
```
