# 12. 설정 및 환경변수

## 12.1 개요

Pydantic Settings를 사용하여 환경 변수 기반의 타입 안전한 설정 관리를 구현합니다. `.env` 파일과 환경 변수를 자동으로 읽어들입니다.

### 관련 파일

- `app/config.py` - 설정 클래스
- `.env` - 환경 변수 파일 (gitignore)
- `.env.example` - 예시 파일 (git에 포함)

---

## 12.2 설정 클래스 (app/config.py)

### 12.2.1 전체 코드

```python
from functools import lru_cache
from typing import List, Optional

from pydantic import field_validator
from pydantic_settings import BaseSettings, SettingsConfigDict


class Settings(BaseSettings):
    """애플리케이션 설정 클래스"""

    model_config = SettingsConfigDict(
        env_file=".env",            # .env 파일 경로
        env_file_encoding="utf-8",  # 파일 인코딩
        case_sensitive=False,       # 대소문자 구분 안 함
        extra="ignore",             # 알 수 없는 필드 무시
    )

    # App Settings
    app_name: str = "FastAPI-HTMX-Boilerplate"
    app_env: str = "development"
    debug: bool = True
    secret_key: str = "change-me-in-production"

    # Database
    database_url: str = "sqlite+aiosqlite:///./app.db"

    # JWT Settings
    jwt_secret_key: str = "change-me-in-production"
    jwt_algorithm: str = "HS256"
    jwt_access_token_expire_minutes: int = 60
    jwt_refresh_token_expire_days: int = 7

    # Server
    host: str = "0.0.0.0"
    port: int = 8001
    reload: bool = True
    workers: int = 1

    # CORS
    cors_origins: List[str] = ["http://localhost:3000", "http://localhost:8000"]

    # Logging
    log_level: str = "INFO"

    # Redis (Optional)
    redis_url: Optional[str] = None


@lru_cache
def get_settings() -> Settings:
    """설정 인스턴스 반환 (캐싱됨)"""
    return Settings()


settings = get_settings()
```

### 12.2.2 Pydantic Settings 특징

| 특징 | 설명 |
|------|------|
| **타입 안전성** | 타입 힌트 기반 자동 변환 |
| **유효성 검사** | 잘못된 값 자동 감지 |
| **기본값** | 환경 변수 없으면 기본값 사용 |
| **자동 로딩** | `.env` 파일 자동 읽기 |
| **대소문자 무시** | `DATABASE_URL` = `database_url` |

---

## 12.3 설정 항목 상세

### 12.3.1 앱 설정

```python
# 애플리케이션 이름
app_name: str = "FastAPI-HTMX-Boilerplate"

# 실행 환경 (development, production, testing)
app_env: str = "development"

# 디버그 모드 (에러 상세 표시)
debug: bool = True

# 비밀 키 (세션, CSRF 등에 사용)
secret_key: str = "change-me-in-production"
```

### 12.3.2 데이터베이스 설정

```python
# 데이터베이스 연결 URL
# SQLite (비동기): sqlite+aiosqlite:///./app.db
# PostgreSQL: postgresql+asyncpg://user:pass@localhost/db
database_url: str = "sqlite+aiosqlite:///./app.db"
```

**데이터베이스 URL 형식:**

| DB | 드라이버 | URL 형식 |
|----|----------|----------|
| SQLite | aiosqlite | `sqlite+aiosqlite:///./app.db` |
| PostgreSQL | asyncpg | `postgresql+asyncpg://user:pass@host:5432/db` |
| MySQL | aiomysql | `mysql+aiomysql://user:pass@host:3306/db` |

### 12.3.3 JWT 설정

```python
# JWT 서명 비밀 키 (반드시 변경!)
jwt_secret_key: str = "change-me-in-production"

# 서명 알고리즘
jwt_algorithm: str = "HS256"

# Access Token 만료 시간 (분)
jwt_access_token_expire_minutes: int = 60  # 1시간

# Refresh Token 만료 시간 (일)
jwt_refresh_token_expire_days: int = 7  # 7일
```

### 12.3.4 서버 설정

```python
# 바인딩 호스트
host: str = "0.0.0.0"  # 모든 인터페이스

# 포트 번호 (기본 8001)
port: int = 8001

# 자동 리로드 (개발용)
reload: bool = True

# 워커 수 (프로덕션)
workers: int = 1
```

### 12.3.5 CORS 설정

```python
# 허용된 오리진 목록
cors_origins: List[str] = [
    "http://localhost:3000",
    "http://localhost:8000"
]
```

**CORS 설정 변환 (Validator):**

```python
@field_validator("cors_origins", mode="before")
@classmethod
def parse_cors_origins(cls, v):
    """CORS origins 문자열을 리스트로 변환"""
    if isinstance(v, str):
        import json
        try:
            # JSON 배열 형식
            return json.loads(v)
        except json.JSONDecodeError:
            # 쉼표 구분 형식
            return [origin.strip() for origin in v.split(",")]
    return v
```

**환경변수 형식 예시:**
```bash
# JSON 배열
CORS_ORIGINS='["http://localhost:3000","http://example.com"]'

# 쉼표 구분
CORS_ORIGINS="http://localhost:3000,http://example.com"
```

### 12.3.6 로깅 설정

```python
# 로그 레벨 (DEBUG, INFO, WARNING, ERROR, CRITICAL)
log_level: str = "INFO"
```

### 12.3.7 Redis 설정 (선택)

```python
# Redis URL (캐싱, 세션 스토어 등)
redis_url: Optional[str] = None

# 예: redis://localhost:6379/0
```

---

## 12.4 환경 속성 (Properties)

```python
@property
def is_development(self) -> bool:
    """개발 환경 여부"""
    return self.app_env == "development"

@property
def is_production(self) -> bool:
    """운영 환경 여부"""
    return self.app_env == "production"

@property
def is_testing(self) -> bool:
    """테스트 환경 여부"""
    return self.app_env == "testing"
```

**사용 예시:**

```python
from app.config import settings

if settings.is_development:
    # 개발 환경 전용 코드
    print("디버그 모드입니다")

if settings.is_production:
    # 프로덕션 환경 전용 코드
    # 예: Sentry 초기화
    pass
```

---

## 12.5 설정 싱글톤 패턴

```python
@lru_cache
def get_settings() -> Settings:
    """설정 인스턴스 반환 (캐싱됨)"""
    return Settings()

# 전역 설정 인스턴스
settings = get_settings()
```

### @lru_cache 효과

- **첫 호출**: `Settings()` 인스턴스 생성
- **이후 호출**: 캐시된 인스턴스 반환
- **메모리 절약**: 하나의 인스턴스만 유지
- **성능 향상**: .env 파일 반복 읽기 방지

---

## 12.6 .env 파일 예시

```bash
# .env 파일 (gitignore에 포함!)

# App Settings
APP_NAME=MyApp
APP_ENV=development
DEBUG=true
SECRET_KEY=my-super-secret-key-change-in-production

# Database
DATABASE_URL=sqlite+aiosqlite:///./app.db
# DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/mydb

# JWT
JWT_SECRET_KEY=jwt-secret-key-change-in-production
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=60
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7

# Server
HOST=0.0.0.0
PORT=8001
RELOAD=true
WORKERS=1

# CORS
CORS_ORIGINS=["http://localhost:3000"]

# Logging
LOG_LEVEL=INFO

# Redis (Optional)
# REDIS_URL=redis://localhost:6379/0
```

---

## 12.7 환경별 설정

### 12.7.1 개발 환경 (.env.development)

```bash
APP_ENV=development
DEBUG=true
RELOAD=true
LOG_LEVEL=DEBUG
DATABASE_URL=sqlite+aiosqlite:///./dev.db
```

### 12.7.2 테스트 환경 (.env.testing)

```bash
APP_ENV=testing
DEBUG=true
DATABASE_URL=sqlite+aiosqlite:///./test.db
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=5
```

### 12.7.3 프로덕션 환경 (.env.production)

```bash
APP_ENV=production
DEBUG=false
RELOAD=false
WORKERS=4
LOG_LEVEL=WARNING

# 반드시 변경!
SECRET_KEY=<랜덤 생성된 키>
JWT_SECRET_KEY=<랜덤 생성된 키>

# 프로덕션 DB
DATABASE_URL=postgresql+asyncpg://user:pass@db-host:5432/prod_db

# CORS (실제 도메인)
CORS_ORIGINS=["https://myapp.com","https://www.myapp.com"]
```

---

## 12.8 설정 사용 예시

### 12.8.1 애플리케이션에서 사용

```python
# app/main.py
from app.config import settings

app = FastAPI(
    title=settings.app_name,
    debug=settings.debug,
)

# CORS 설정
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 12.8.2 데이터베이스 연결

```python
# app/database.py
from app.config import settings

engine = create_async_engine(
    settings.database_url,
    echo=settings.debug,  # 디버그 모드면 SQL 로깅
)
```

### 12.8.3 JWT 토큰 생성

```python
# app/core/security.py
from app.config import settings

def create_access_token(data: dict) -> str:
    expire = datetime.utcnow() + timedelta(
        minutes=settings.jwt_access_token_expire_minutes
    )
    to_encode = data.copy()
    to_encode.update({"exp": expire})

    return jwt.encode(
        to_encode,
        settings.jwt_secret_key,
        algorithm=settings.jwt_algorithm,
    )
```

### 12.8.4 템플릿 전역 변수

```python
# app/core/templates.py
from app.config import settings

templates.env.globals["app_name"] = settings.app_name
templates.env.globals["debug"] = settings.debug
```

---

## 12.9 서버 실행 스크립트 (run.py)

```python
# run.py
import uvicorn

from app.config import settings

if __name__ == "__main__":
    uvicorn.run(
        "app.main:app",
        host=settings.host,
        port=settings.port,
        reload=settings.reload,
        workers=settings.workers if not settings.reload else 1,
    )
```

**실행:**
```bash
python run.py
# 또는
uvicorn app.main:app --reload --port 8001
```

---

## 12.10 설정 검증 및 디버깅

### 12.10.1 현재 설정 확인

```python
from app.config import settings

# 모든 설정 출력
print(settings.model_dump())
# {
#     'app_name': 'FastAPI-HTMX-Boilerplate',
#     'app_env': 'development',
#     'debug': True,
#     ...
# }
```

### 12.10.2 환경 변수 오버라이드

```bash
# .env 파일 값 대신 환경 변수 우선
export DEBUG=false
export PORT=9000

python run.py
# DEBUG=False, PORT=9000으로 실행
```

### 12.10.3 Docker에서 환경 변수

```yaml
# docker-compose.yml
services:
  app:
    build: .
    environment:
      - APP_ENV=production
      - DATABASE_URL=postgresql+asyncpg://...
      - SECRET_KEY=${SECRET_KEY}  # 호스트 환경 변수 참조
```

---

## 12.11 보안 고려사항

### 12.11.1 비밀 키 생성

```python
# 랜덤 비밀 키 생성
import secrets

# 256비트 (32바이트) 키
print(secrets.token_hex(32))
# 예: a1b2c3d4e5f6...

# URL-safe 토큰
print(secrets.token_urlsafe(32))
# 예: Ab_cD1-eF2...
```

### 12.11.2 절대 하지 말아야 할 것

```python
# ❌ 잘못된 예
jwt_secret_key: str = "change-me-in-production"  # 기본값 그대로 사용

# ❌ 잘못된 예
# .env 파일을 git에 커밋
```

### 12.11.3 권장 사항

1. **프로덕션 비밀 키는 환경 변수로 주입**
   ```bash
   export JWT_SECRET_KEY=$(python -c "import secrets; print(secrets.token_hex(32))")
   ```

2. **.gitignore에 .env 추가**
   ```gitignore
   .env
   .env.local
   .env.production
   ```

3. **.env.example 제공**
   ```bash
   # .env.example
   SECRET_KEY=change-me
   JWT_SECRET_KEY=change-me
   ```

4. **시크릿 관리 서비스 사용** (프로덕션)
   - AWS Secrets Manager
   - HashiCorp Vault
   - Azure Key Vault

