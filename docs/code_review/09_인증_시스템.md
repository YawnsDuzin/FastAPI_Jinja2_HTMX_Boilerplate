# 09. 인증 시스템

## 9.1 개요

이 프로젝트는 **JWT(JSON Web Token) 기반 인증**을 사용합니다. 토큰은 **httpOnly 쿠키**에 저장되어 XSS 공격으로부터 보호됩니다.

### 관련 파일

- `app/core/security.py` - 보안 유틸리티 (JWT, 비밀번호 해싱)
- `app/api/deps.py` - 인증 의존성
- `app/services/auth.py` - 인증 서비스

---

## 9.2 JWT 토큰 구조

### 9.2.1 JWT란?

JWT는 사용자 인증 정보를 JSON 형식으로 인코딩한 토큰입니다.

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjMiLCJleHAiOjE2NTAwMDAwMDAsInR5cGUiOiJhY2Nlc3MifQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
│                                    │                                                        │
└──────────────── Header ────────────┴────────────────────── Payload ─────────────────────────┴──────────── Signature ────────────┘
```

### 9.2.2 토큰 구성

| 부분 | 내용 | 예시 |
|------|------|------|
| **Header** | 알고리즘, 타입 | `{"alg": "HS256", "typ": "JWT"}` |
| **Payload** | 데이터 (클레임) | `{"sub": "123", "exp": 1650000000, "type": "access"}` |
| **Signature** | 서명 | HMAC-SHA256 해시 |

### 9.2.3 Access Token vs Refresh Token

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Access Token                                   │
├─────────────────────────────────────────────────────────────────────┤
│ • 수명: 짧음 (1시간)                                                │
│ • 용도: API 요청 인증                                               │
│ • 저장: httpOnly 쿠키                                               │
│ • 탈취 시: 짧은 시간만 유효                                         │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                      Refresh Token                                  │
├─────────────────────────────────────────────────────────────────────┤
│ • 수명: 김 (7일)                                                    │
│ • 용도: 새 Access Token 발급                                        │
│ • 저장: httpOnly 쿠키                                               │
│ • 사용 빈도: 낮음 (탈취 위험 감소)                                   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 9.3 보안 유틸리티 (app/core/security.py)

### 9.3.1 비밀번호 해싱

```python
import bcrypt


def verify_password(plain_password: str, hashed_password: str) -> bool:
    """
    평문 비밀번호와 해시된 비밀번호 비교

    bcrypt의 checkpw 함수 사용:
    - 자동으로 salt 추출 및 비교
    - 타이밍 공격 방지
    """
    return bcrypt.checkpw(
        plain_password.encode("utf-8"),
        hashed_password.encode("utf-8")
    )


def get_password_hash(password: str) -> str:
    """
    비밀번호 해싱

    bcrypt 사용 이유:
    - 자동으로 random salt 생성
    - 같은 비밀번호도 매번 다른 해시값
    - 의도적으로 느림 (brute force 방지)
    """
    return bcrypt.hashpw(
        password.encode("utf-8"),
        bcrypt.gensalt()
    ).decode("utf-8")
```

### 9.3.2 비밀번호 해싱 흐름

```
원본 비밀번호: "mypassword123"
         │
         ▼
┌─────────────────────────────────┐
│       bcrypt.gensalt()          │  ← 랜덤 salt 생성
│ "$2b$12$LQv3c1yqBWVHxkd0LHAkCO"│
└─────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    bcrypt.hashpw()                                  │
│ 입력: 비밀번호 + salt                                               │
│ 출력: "$2b$12$LQv3c1yqBWVHxkd0LHAkCOeHNAm7KDqTqRlX.UQT.gn9d3ABO"   │
└─────────────────────────────────────────────────────────────────────┘

검증 시:
┌─────────────────────────────────────────────────────────────────────┐
│ bcrypt.checkpw(입력 비밀번호, 저장된 해시)                           │
│ 1. 해시에서 salt 추출                                               │
│ 2. 입력 비밀번호 + salt로 해시 생성                                  │
│ 3. 두 해시 비교                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 9.3.3 Access Token 생성

```python
from datetime import datetime, timedelta, timezone
from jose import jwt

from app.config import settings


def create_access_token(
    subject: str | int,
    expires_delta: Optional[timedelta] = None,
    extra_data: Optional[dict[str, Any]] = None,
) -> str:
    """
    JWT 액세스 토큰 생성

    Args:
        subject: 토큰 주체 (사용자 ID)
        expires_delta: 만료 시간
        extra_data: 추가 데이터

    Returns:
        인코딩된 JWT 문자열
    """
    if expires_delta:
        expire = datetime.now(timezone.utc) + expires_delta
    else:
        expire = datetime.now(timezone.utc) + timedelta(
            minutes=settings.jwt_access_token_expire_minutes
        )

    to_encode = {
        "sub": str(subject),           # Subject (사용자 ID)
        "exp": expire,                 # Expiration (만료 시간)
        "iat": datetime.now(timezone.utc),  # Issued At (발급 시간)
        "type": "access",              # 토큰 타입
    }

    if extra_data:
        to_encode.update(extra_data)

    encoded_jwt = jwt.encode(
        to_encode,
        settings.jwt_secret_key,
        algorithm=settings.jwt_algorithm,
    )
    return encoded_jwt
```

### 9.3.4 Refresh Token 생성

```python
def create_refresh_token(subject: str | int) -> str:
    """JWT 리프레시 토큰 생성"""
    expire = datetime.now(timezone.utc) + timedelta(
        days=settings.jwt_refresh_token_expire_days
    )

    to_encode = {
        "sub": str(subject),
        "exp": expire,
        "iat": datetime.now(timezone.utc),
        "type": "refresh",  # access와 구분
    }

    encoded_jwt = jwt.encode(
        to_encode,
        settings.jwt_secret_key,
        algorithm=settings.jwt_algorithm,
    )
    return encoded_jwt
```

### 9.3.5 토큰 검증

```python
from jose import JWTError, jwt


def verify_token(token: str, token_type: str = "access") -> Optional[dict[str, Any]]:
    """
    JWT 토큰 검증

    Args:
        token: 검증할 JWT 토큰
        token_type: 토큰 타입 ("access" 또는 "refresh")

    Returns:
        토큰 페이로드 또는 None (검증 실패 시)
    """
    try:
        # 토큰 디코딩 및 서명 검증
        payload = jwt.decode(
            token,
            settings.jwt_secret_key,
            algorithms=[settings.jwt_algorithm],
        )

        # 토큰 타입 검증 (access 토큰으로 refresh 못하게)
        if payload.get("type") != token_type:
            return None

        return payload
    except JWTError:
        # 만료, 서명 오류 등
        return None
```

---

## 9.4 인증 흐름

### 9.4.1 로그인 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                         1. 로그인 요청                              │
│  POST /api/v1/auth/login                                           │
│  Body: {"email": "user@example.com", "password": "secret"}         │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         2. 서버 검증                                │
│  • 이메일로 사용자 조회                                             │
│  • bcrypt로 비밀번호 검증                                           │
│  • 계정 활성 상태 확인                                              │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         3. 토큰 생성                                │
│  • Access Token (1시간)                                             │
│  • Refresh Token (7일)                                              │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         4. 쿠키 설정                                │
│  Set-Cookie: access_token=...; HttpOnly; SameSite=Lax              │
│  Set-Cookie: refresh_token=...; HttpOnly; SameSite=Lax             │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         5. 응답                                     │
│  {"access_token": "...", "refresh_token": "...", "token_type": "..."}│
└─────────────────────────────────────────────────────────────────────┘
```

### 9.4.2 인증된 요청 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                         1. API 요청                                 │
│  GET /api/v1/items                                                 │
│  Cookie: access_token=eyJ...                                       │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  2. 의존성 주입 (deps.py)                           │
│  get_token_from_cookie() → access_token 추출                       │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  3. 토큰 검증 (security.py)                         │
│  verify_token(token, "access")                                     │
│  → 서명 검증, 만료 확인, 타입 확인                                  │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  4. 사용자 조회                                     │
│  payload["sub"] → user_id                                          │
│  UserService.get_by_id(user_id)                                    │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  5. 라우터 핸들러 실행                               │
│  async def get_items(current_user: CurrentUser):                   │
│      # current_user에 User 객체가 주입됨                            │
└─────────────────────────────────────────────────────────────────────┘
```

### 9.4.3 토큰 갱신 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│              Access Token 만료 → 401 에러                           │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│              클라이언트: /api/v1/auth/refresh 호출                  │
│              Body: refresh_token                                    │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│              서버: Refresh Token 검증                               │
│              • 서명 검증                                            │
│              • 만료 확인                                            │
│              • 타입 확인 (refresh)                                  │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│              새 토큰 쌍 발급                                        │
│              • 새 Access Token                                      │
│              • 새 Refresh Token (토큰 로테이션)                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 9.5 httpOnly 쿠키

### 9.5.1 왜 httpOnly 쿠키를 사용하나요?

| 저장 방식 | XSS 공격 | CSRF 공격 | 권장 |
|-----------|----------|-----------|------|
| localStorage | 취약 | 안전 | X |
| sessionStorage | 취약 | 안전 | X |
| 일반 쿠키 | 취약 | 취약 | X |
| httpOnly 쿠키 | 안전 | 취약 (SameSite로 방어) | O |

### 9.5.2 쿠키 설정

```python
response.set_cookie(
    key="access_token",
    value=tokens.access_token,
    httponly=True,      # JavaScript에서 접근 불가
    secure=False,       # Production에서는 True (HTTPS만 허용)
    samesite="lax",     # CSRF 방어
    max_age=3600,       # 1시간
)
```

### 9.5.3 보안 옵션

| 옵션 | 값 | 설명 |
|------|-----|------|
| `httponly` | `True` | JavaScript `document.cookie`로 접근 불가 |
| `secure` | `True` | HTTPS 연결에서만 전송 |
| `samesite` | `lax` | 같은 사이트에서만 쿠키 전송 (GET은 허용) |
| `max_age` | 초 | 쿠키 유효 기간 |

---

## 9.6 의존성 체인

```python
# 타입 별칭 정의
CurrentUser = Annotated[User, Depends(get_current_user)]
CurrentUserOptional = Annotated[Optional[User], Depends(get_current_user_optional)]
CurrentSuperuser = Annotated[User, Depends(get_current_superuser)]
```

### 의존성 체인 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                        CurrentSuperuser                             │
│                   (관리자 권한 확인)                                │
└─────────────────────────────────────────────────────────────────────┘
                                │
                        Depends ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         CurrentUser                                 │
│                   (인증 및 사용자 조회)                             │
│                                                                     │
│  • 토큰 없음 → 401                                                  │
│  • 토큰 무효 → 401                                                  │
│  • 사용자 없음 → 401                                                │
│  • 비활성 계정 → 401                                                │
└─────────────────────────────────────────────────────────────────────┘
                                │
                        Depends ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    get_token_from_cookie                            │
│                   (쿠키에서 토큰 추출)                              │
│                                                                     │
│  Cookie("access_token") → Optional[str]                             │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        HTTP 요청                                    │
│                   Cookie: access_token=...                          │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 9.7 보안 고려사항

### 9.7.1 구현된 보안 조치

| 조치 | 설명 |
|------|------|
| **bcrypt 해싱** | 비밀번호를 안전하게 저장 |
| **httpOnly 쿠키** | XSS 공격 방지 |
| **SameSite=Lax** | CSRF 공격 방지 |
| **짧은 Access Token** | 탈취 시 영향 최소화 |
| **토큰 타입 검증** | Access/Refresh 혼용 방지 |
| **모호한 에러 메시지** | 이메일 존재 여부 노출 방지 |

### 9.7.2 추가 권장 조치 (미구현)

| 조치 | 설명 |
|------|------|
| Rate Limiting | 로그인 시도 횟수 제한 |
| 계정 잠금 | 연속 실패 시 계정 잠금 |
| IP 기반 제한 | 의심스러운 IP 차단 |
| 이중 인증 | 2FA/MFA 구현 |
| 세션 무효화 | 비밀번호 변경 시 모든 세션 로그아웃 |
