# 04. 스키마 검증 (Pydantic)

## 4.1 개요

이 프로젝트는 **Pydantic 2.0+**을 사용하여 데이터 검증 및 직렬화를 수행합니다. 스키마는 API 요청/응답의 데이터 구조를 정의하고, 자동으로 유효성 검사를 수행합니다.

### 관련 파일

- `app/schemas/user.py` - 사용자 스키마
- `app/schemas/item.py` - 아이템 스키마
- `app/schemas/common.py` - 공통 스키마

### 스키마의 역할

```
┌─────────────────────────────────────────────────────────────────────┐
│                         HTTP 요청                                   │
│                    { "email": "...", "password": "..." }            │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Pydantic 스키마 검증                             │
│   • 타입 검사 (str, int, bool 등)                                   │
│   • 필수 필드 확인                                                  │
│   • 제약 조건 검사 (min_length, max_length 등)                      │
│   • 커스텀 검증 (이메일 형식, 비밀번호 강도 등)                     │
└─────────────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    ▼                       ▼
            ┌───────────────┐       ┌───────────────┐
            │ 검증 성공     │       │ 검증 실패     │
            │ → 처리 진행   │       │ → 422 에러    │
            └───────────────┘       └───────────────┘
```

---

## 4.2 사용자 스키마 (app/schemas/user.py)

### 4.2.1 스키마 계층 구조

```python
from datetime import datetime
from typing import Optional
from pydantic import BaseModel, ConfigDict, EmailStr, Field


class UserBase(BaseModel):
    """사용자 기본 스키마 - 공통 필드 정의"""

    email: EmailStr                                    # 이메일 형식 검증
    username: str = Field(min_length=3, max_length=50) # 길이 제한
    full_name: Optional[str] = Field(None, max_length=100)


class UserCreate(UserBase):
    """사용자 생성 스키마 - 회원가입 시 사용"""

    password: str = Field(min_length=8, max_length=100)


class UserUpdate(BaseModel):
    """사용자 수정 스키마 - 모든 필드 선택적"""

    email: Optional[EmailStr] = None
    username: Optional[str] = Field(None, min_length=3, max_length=50)
    full_name: Optional[str] = Field(None, max_length=100)
    avatar_url: Optional[str] = None
    password: Optional[str] = Field(None, min_length=8, max_length=100)


class User(UserBase):
    """사용자 응답 스키마 - API 응답에 사용"""

    model_config = ConfigDict(from_attributes=True)

    id: int
    avatar_url: Optional[str] = None
    is_active: bool
    is_superuser: bool
    is_verified: bool
    created_at: datetime
    updated_at: datetime
```

### 4.2.2 스키마 상속 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                           BaseModel                                 │
│                         (Pydantic)                                  │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           UserBase                                  │
│  • email: EmailStr                                                  │
│  • username: str (3-50자)                                           │
│  • full_name: Optional[str] (최대 100자)                            │
└─────────────────────────────────────────────────────────────────────┘
                    │                       │
                    ▼                       ▼
┌───────────────────────────┐   ┌─────────────────────────────────────┐
│       UserCreate          │   │             User                    │
│  + password: str (8-100)  │   │  + id: int                          │
│                           │   │  + avatar_url: Optional[str]        │
│  (회원가입 요청)          │   │  + is_active: bool                   │
└───────────────────────────┘   │  + is_superuser: bool                │
                                │  + is_verified: bool                 │
                                │  + created_at: datetime              │
                                │  + updated_at: datetime              │
                                │                                     │
                                │  (API 응답)                          │
                                └─────────────────────────────────────┘
```

### 4.2.3 Field 옵션 상세

| 옵션 | 설명 | 예시 |
|------|------|------|
| `min_length` | 최소 문자열 길이 | `Field(min_length=8)` |
| `max_length` | 최대 문자열 길이 | `Field(max_length=100)` |
| `ge` | 이상 (greater than or equal) | `Field(ge=0)` |
| `le` | 이하 (less than or equal) | `Field(le=10)` |
| `default` | 기본값 | `Field(default=0)` |
| `description` | OpenAPI 문서 설명 | `Field(description="사용자 이메일")` |

### 4.2.4 인증 관련 스키마

```python
class UserLogin(BaseModel):
    """로그인 요청 스키마"""

    email: EmailStr
    password: str


class Token(BaseModel):
    """토큰 응답 스키마"""

    access_token: str
    refresh_token: str
    token_type: str = "bearer"


class TokenPayload(BaseModel):
    """토큰 페이로드 스키마 (JWT 디코딩 결과)"""

    sub: str     # subject (사용자 ID)
    exp: int     # expiration (만료 시간)
    type: str    # access 또는 refresh


class PasswordChange(BaseModel):
    """비밀번호 변경 스키마"""

    current_password: str
    new_password: str = Field(min_length=8, max_length=100)
```

---

## 4.3 아이템 스키마 (app/schemas/item.py)

```python
from __future__ import annotations

from datetime import datetime
from typing import TYPE_CHECKING, Optional
from pydantic import BaseModel, ConfigDict, Field

if TYPE_CHECKING:
    from app.schemas.user import User


class ItemBase(BaseModel):
    """아이템 기본 스키마"""

    title: str = Field(min_length=1, max_length=200)
    description: Optional[str] = None
    priority: int = Field(default=0, ge=0, le=10)  # 0-10 범위


class ItemCreate(ItemBase):
    """아이템 생성 스키마"""
    pass  # ItemBase의 모든 필드 상속


class ItemUpdate(BaseModel):
    """아이템 수정 스키마 - 모든 필드 선택적"""

    title: Optional[str] = Field(None, min_length=1, max_length=200)
    description: Optional[str] = None
    priority: Optional[int] = Field(None, ge=0, le=10)
    is_active: Optional[bool] = None


class Item(ItemBase):
    """아이템 응답 스키마"""

    model_config = ConfigDict(from_attributes=True)

    id: int
    is_active: bool
    owner_id: int
    created_at: datetime
    updated_at: datetime


class ItemWithOwner(Item):
    """소유자 정보 포함 아이템 스키마"""

    owner: User  # 중첩된 스키마
```

### 4.3.1 스키마 사용 예시

```python
# 생성 시
item_data = ItemCreate(
    title="새 아이템",
    description="설명",
    priority=5
)

# 수정 시 (일부 필드만)
update_data = ItemUpdate(title="수정된 제목")  # 다른 필드는 None

# 응답 변환
item_response = Item.model_validate(db_item)  # ORM → Pydantic
```

---

## 4.4 공통 스키마 (app/schemas/common.py)

### 4.4.1 메시지 응답

```python
class Message(BaseModel):
    """간단한 메시지 응답 스키마"""

    message: str
```

### 4.4.2 페이지네이션 응답

```python
from typing import Generic, List, TypeVar

T = TypeVar("T")


class PaginatedResponse(BaseModel, Generic[T]):
    """페이지네이션 응답 스키마 (제네릭)"""

    model_config = ConfigDict(from_attributes=True)

    items: List[T]    # 데이터 목록
    total: int        # 전체 개수
    page: int         # 현재 페이지
    size: int         # 페이지 크기
    pages: int        # 전체 페이지 수

    @classmethod
    def create(
        cls,
        items: List[T],
        total: int,
        page: int,
        size: int,
    ) -> "PaginatedResponse[T]":
        """페이지네이션 응답 생성 헬퍼"""
        pages = (total + size - 1) // size if size > 0 else 0
        return cls(
            items=items,
            total=total,
            page=page,
            size=size,
            pages=pages,
        )
```

#### 사용 예시

```python
# 라우터에서 사용
@router.get("/paginated", response_model=PaginatedResponse[Item])
async def get_items_paginated(...):
    items = await item_service.get_all(...)
    total = await item_service.count(...)

    return PaginatedResponse.create(
        items=items,
        total=total,
        page=page,
        size=size,
    )
```

#### 응답 예시

```json
{
    "items": [
        {"id": 1, "title": "아이템 1", ...},
        {"id": 2, "title": "아이템 2", ...}
    ],
    "total": 100,
    "page": 1,
    "size": 20,
    "pages": 5
}
```

### 4.4.3 에러 응답

```python
class ErrorResponse(BaseModel):
    """에러 응답 스키마"""

    error: bool = True
    message: str
    detail: dict[str, Any] | None = None
```

---

## 4.5 model_config 옵션

### 4.5.1 from_attributes (구 orm_mode)

```python
class User(UserBase):
    model_config = ConfigDict(from_attributes=True)
```

이 옵션을 설정하면 SQLAlchemy 모델을 Pydantic 스키마로 변환할 수 있습니다:

```python
# SQLAlchemy 모델
db_user = User(id=1, email="test@example.com", ...)

# Pydantic 스키마로 변환
user_schema = UserSchema.model_validate(db_user)
```

### 4.5.2 변환 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│              SQLAlchemy Model (ORM 객체)                            │
│   User(id=1, email="test@example.com", username="user1", ...)       │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                │ model_validate()
                                │ (from_attributes=True 필요)
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│              Pydantic Schema (검증된 데이터)                        │
│   UserSchema(id=1, email="test@example.com", ...)                   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                │ model_dump() 또는 자동 직렬화
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│              JSON Response                                          │
│   {"id": 1, "email": "test@example.com", ...}                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4.6 검증 실패 시 에러 응답

Pydantic 검증이 실패하면 FastAPI가 자동으로 422 에러를 반환합니다:

```json
{
    "detail": [
        {
            "type": "string_too_short",
            "loc": ["body", "password"],
            "msg": "String should have at least 8 characters",
            "input": "short",
            "ctx": {"min_length": 8}
        }
    ]
}
```

### 에러 응답 구조

| 필드 | 설명 |
|------|------|
| `type` | 에러 유형 |
| `loc` | 에러 위치 (body, query, path 등) |
| `msg` | 사람이 읽을 수 있는 에러 메시지 |
| `input` | 실제 입력된 값 |
| `ctx` | 추가 컨텍스트 (제약 조건 등) |

---

## 4.7 스키마 설계 패턴

### 4.7.1 Base-Create-Update-Response 패턴

```
┌─────────────────────────────────────────────────────────────────────┐
│                          XXXBase                                    │
│               공통 필드 정의 (title, description 등)                │
└─────────────────────────────────────────────────────────────────────┘
                    │           │           │
                    ▼           ▼           ▼
┌───────────────┐  ┌─────────────────┐  ┌────────────────────────────┐
│   XXXCreate   │  │    XXXUpdate    │  │          XXX               │
│               │  │                 │  │   (Response Schema)        │
│ + 생성 전용   │  │ 모든 필드       │  │ + id                       │
│   필드        │  │ Optional        │  │ + created_at               │
│               │  │                 │  │ + updated_at               │
└───────────────┘  └─────────────────┘  └────────────────────────────┘

     입력용              수정용                  출력용
(POST 요청 바디)   (PATCH 요청 바디)        (응답 바디)
```

### 4.7.2 장점

1. **코드 중복 감소**: 공통 필드를 Base에서 한 번만 정의
2. **유지보수 용이**: 필드 변경 시 한 곳만 수정
3. **명확한 의도**: 각 스키마의 용도가 명확
4. **타입 안전성**: 컴파일 타임에 타입 오류 감지
