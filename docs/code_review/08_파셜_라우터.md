# 08. 파셜 라우터 (HTMX)

## 8.1 개요

파셜 라우터는 **HTML 조각(fragment)**을 반환합니다. HTMX 요청에 대응하여 페이지의 일부분만 업데이트할 수 있게 해줍니다. 전체 페이지를 새로고침하지 않고도 동적인 사용자 경험을 제공합니다.

### 관련 파일

- `app/partials/router.py` - 라우터 통합
- `app/partials/auth.py` - 인증 파셜
- `app/partials/items.py` - 아이템 파셜
- `app/partials/modals.py` - 모달 파셜
- `app/partials/toasts.py` - 토스트 파셜

### URL 구조

```
/partials/
├── auth/
│   ├── POST /register      # 회원가입 처리 (HTMX)
│   └── POST /login         # 로그인 처리 (HTMX)
│
├── items/
│   ├── GET  /              # 아이템 목록
│   ├── GET  /form          # 아이템 생성 폼
│   ├── GET  /{id}          # 단일 아이템
│   ├── GET  /{id}/edit     # 아이템 수정 폼
│   ├── POST /              # 아이템 생성
│   ├── PUT  /{id}          # 아이템 수정
│   ├── DELETE /{id}        # 아이템 삭제
│   └── POST /{id}/toggle   # 활성/비활성 토글
│
├── modals/
│   ├── GET /confirm        # 확인 모달
│   ├── GET /alert          # 알림 모달
│   └── GET /form/{type}    # 폼 모달
│
└── toasts/
    ├── GET /success        # 성공 토스트
    ├── GET /error          # 에러 토스트
    ├── GET /info           # 정보 토스트
    └── GET /warning        # 경고 토스트
```

---

## 8.2 HTMX 기본 개념

### 8.2.1 HTMX 핵심 속성

```html
<!-- 기본 요청 -->
<button hx-get="/partials/items"      <!-- GET 요청 -->
        hx-target="#items-list"       <!-- 응답을 넣을 요소 -->
        hx-swap="innerHTML">          <!-- 교체 방식 -->
    아이템 로드
</button>

<!-- POST 요청 (폼) -->
<form hx-post="/partials/items"
      hx-target="#items-list"
      hx-swap="afterbegin">           <!-- 맨 앞에 추가 -->
    ...
</form>

<!-- DELETE 요청 -->
<button hx-delete="/partials/items/1"
        hx-target="#item-1"
        hx-swap="outerHTML">          <!-- 요소 전체 교체 -->
    삭제
</button>
```

### 8.2.2 swap 옵션

| 옵션 | 설명 |
|------|------|
| `innerHTML` | 내부 HTML 교체 (기본값) |
| `outerHTML` | 요소 전체 교체 |
| `beforebegin` | 요소 앞에 추가 |
| `afterbegin` | 요소 내부 맨 앞에 추가 |
| `beforeend` | 요소 내부 맨 뒤에 추가 |
| `afterend` | 요소 뒤에 추가 |
| `delete` | 요소 삭제 |
| `none` | 아무것도 하지 않음 |

---

## 8.3 인증 파셜 (app/partials/auth.py)

### 8.3.1 회원가입 파셜

```python
@router.post("/register", response_class=HTMLResponse)
async def register_partial(
    auth_service: Annotated[AuthService, Depends(get_auth_service)],
    email: str = Form(...),
    username: str = Form(...),
    password: str = Form(...),
    full_name: Optional[str] = Form(None),
):
    """회원가입 (HTMX)"""
    try:
        user_in = UserCreate(
            email=email,
            username=username,
            password=password,
            full_name=full_name if full_name else None,
        )
        await auth_service.register(user_in)
        await auth_service.db.commit()

        # 성공 - HX-Redirect로 로그인 페이지로 이동
        response = HTMLResponse(
            content="""
            <div class="p-4 bg-green-50 text-green-700 rounded-lg">
                회원가입이 완료되었습니다. 로그인 페이지로 이동합니다...
            </div>
            """,
            status_code=200,
        )
        response.headers["HX-Redirect"] = "/login"
        return response

    except Exception as e:
        await auth_service.db.rollback()
        error_message = str(e)
        if "이미 등록된 이메일" in error_message:
            error_message = "이미 등록된 이메일입니다."

        return HTMLResponse(
            content=f"""
            <div class="p-4 bg-red-50 text-red-700 rounded-lg">
                {error_message}
            </div>
            """,
            status_code=200,  # HTMX는 200 응답만 처리
        )
```

### 8.3.2 로그인 파셜

```python
@router.post("/login", response_class=HTMLResponse)
async def login_partial(
    auth_service: Annotated[AuthService, Depends(get_auth_service)],
    email: str = Form(...),
    password: str = Form(...),
):
    """로그인 (HTMX)"""
    try:
        tokens = await auth_service.login(email, password)

        response = HTMLResponse(content="", status_code=200)

        # 쿠키 설정
        response.set_cookie(
            key="access_token",
            value=tokens.access_token,
            httponly=True,
            secure=False,
            samesite="lax",
            max_age=3600,
        )
        response.set_cookie(
            key="refresh_token",
            value=tokens.refresh_token,
            httponly=True,
            secure=False,
            samesite="lax",
            max_age=604800,
        )

        # 성공 시 리다이렉트
        response.headers["HX-Redirect"] = "/dashboard"
        return response

    except Exception as e:
        return HTMLResponse(
            content=f"""
            <div class="p-4 bg-red-50 text-red-700 rounded-lg">
                이메일 또는 비밀번호가 올바르지 않습니다.
            </div>
            """,
            status_code=200,
        )
```

### 8.3.3 HTMX 특수 헤더

| 헤더 | 설명 |
|------|------|
| `HX-Redirect` | 페이지 리다이렉트 |
| `HX-Refresh` | 페이지 새로고침 |
| `HX-Trigger` | 이벤트 트리거 (JSON) |
| `HX-Retarget` | 타겟 요소 변경 |
| `HX-Reswap` | swap 방식 변경 |

---

## 8.4 아이템 파셜 (app/partials/items.py)

### 8.4.1 아이템 목록

```python
@router.get("", response_class=HTMLResponse)
async def get_items_partial(
    request: Request,
    current_user: CurrentUser,
    item_service: Annotated[ItemService, Depends(get_item_service)],
    search: Optional[str] = None,
    page: int = Query(1, ge=1),
):
    """아이템 목록 파셜"""
    page_size = 10
    skip = (page - 1) * page_size

    items = await item_service.get_all(
        owner_id=current_user.id,
        skip=skip,
        limit=page_size,
        search=search,
    )

    return templates.TemplateResponse(
        request=request,
        name="partials/items/list.html",
        context={"items": items, "search": search},
    )
```

### 8.4.2 아이템 생성 폼

```python
@router.get("/form", response_class=HTMLResponse)
async def get_item_form(request: Request, current_user: CurrentUser):
    """아이템 생성 폼 파셜"""
    return templates.TemplateResponse(
        request=request,
        name="partials/items/form.html",
        context={"item": None, "action": "create"},
    )
```

### 8.4.3 아이템 생성

```python
@router.post("", response_class=HTMLResponse)
async def create_item_partial(
    request: Request,
    current_user: CurrentUser,
    item_service: Annotated[ItemService, Depends(get_item_service)],
    title: str = Form(...),
    description: Optional[str] = Form(None),
    priority: int = Form(0),
):
    """아이템 생성 (HTMX)"""
    item_in = ItemCreate(title=title, description=description, priority=priority)
    item = await item_service.create(item_in, current_user)

    response = templates.TemplateResponse(
        request=request,
        name="partials/items/item.html",
        context={"item": item},
    )

    # HX-Trigger로 토스트 알림 및 모달 닫기
    response.headers["HX-Trigger"] = json.dumps(
        {
            "showToast": {"type": "success", "message": "아이템이 생성되었습니다."},
            "closeModal": True,
        }
    )

    return response
```

### 8.4.4 아이템 수정

```python
@router.put("/{item_id}", response_class=HTMLResponse)
async def update_item_partial(
    request: Request,
    item_id: int,
    current_user: CurrentUser,
    item_service: Annotated[ItemService, Depends(get_item_service)],
    title: str = Form(...),
    description: Optional[str] = Form(None),
    priority: int = Form(0),
):
    """아이템 수정 (HTMX)"""
    item = await item_service.get_or_404(item_id, owner_id=current_user.id)
    item_in = ItemUpdate(title=title, description=description, priority=priority)
    updated_item = await item_service.update(item, item_in)

    response = templates.TemplateResponse(
        request=request,
        name="partials/items/item.html",
        context={"item": updated_item},
    )

    response.headers["HX-Trigger"] = json.dumps(
        {
            "showToast": {"type": "success", "message": "아이템이 수정되었습니다."},
            "closeModal": True,
        }
    )

    return response
```

### 8.4.5 아이템 삭제

```python
@router.delete("/{item_id}", response_class=HTMLResponse)
async def delete_item_partial(
    item_id: int,
    current_user: CurrentUser,
    item_service: Annotated[ItemService, Depends(get_item_service)],
):
    """아이템 삭제 (HTMX)"""
    item = await item_service.get_or_404(item_id, owner_id=current_user.id)
    await item_service.delete(item)

    # 빈 응답 + 토스트 트리거
    response = HTMLResponse(content="")  # 요소 삭제됨
    response.headers["HX-Trigger"] = json.dumps(
        {"showToast": {"type": "success", "message": "아이템이 삭제되었습니다."}}
    )

    return response
```

### 8.4.6 활성/비활성 토글

```python
@router.post("/{item_id}/toggle", response_class=HTMLResponse)
async def toggle_item_partial(
    request: Request,
    item_id: int,
    current_user: CurrentUser,
    item_service: Annotated[ItemService, Depends(get_item_service)],
):
    """아이템 활성/비활성 토글 (HTMX)"""
    item = await item_service.get_or_404(item_id, owner_id=current_user.id)
    updated_item = await item_service.toggle_active(item)

    response = templates.TemplateResponse(
        request=request,
        name="partials/items/item.html",
        context={"item": updated_item},
    )

    status = "활성화" if updated_item.is_active else "비활성화"
    response.headers["HX-Trigger"] = json.dumps(
        {"showToast": {"type": "info", "message": f"아이템이 {status}되었습니다."}}
    )

    return response
```

---

## 8.5 모달 파셜 (app/partials/modals.py)

### 8.5.1 확인 모달

```python
@router.get("/confirm", response_class=HTMLResponse)
async def confirm_modal(
    request: Request,
    current_user: CurrentUser,
    title: str = "확인",
    message: str = "정말 진행하시겠습니까?",
    confirm_url: str = "",
    confirm_method: str = "DELETE",
    confirm_target: str = "",
):
    """확인 모달 파셜"""
    return templates.TemplateResponse(
        request=request,
        name="partials/modals/confirm.html",
        context={
            "title": title,
            "message": message,
            "confirm_url": confirm_url,
            "confirm_method": confirm_method,
            "confirm_target": confirm_target,
        },
    )
```

### 8.5.2 사용 예시

```html
<!-- 모달 열기 버튼 -->
<button hx-get="/partials/modals/confirm?title=삭제확인&message=정말 삭제하시겠습니까?&confirm_url=/partials/items/1&confirm_target=#item-1"
        hx-target="#modal-content"
        hx-swap="innerHTML"
        @click="$dispatch('openModal')">
    삭제
</button>
```

---

## 8.6 토스트 파셜 (app/partials/toasts.py)

```python
@router.get("/success", response_class=HTMLResponse)
async def success_toast(request: Request, message: str = "성공적으로 처리되었습니다."):
    """성공 토스트"""
    return templates.TemplateResponse(
        request=request,
        name="partials/toasts/success.html",
        context={"message": message},
    )


@router.get("/error", response_class=HTMLResponse)
async def error_toast(request: Request, message: str = "오류가 발생했습니다."):
    """에러 토스트"""
    return templates.TemplateResponse(
        request=request,
        name="partials/toasts/error.html",
        context={"message": message},
    )
```

---

## 8.7 HX-Trigger를 통한 토스트/모달 제어

### 8.7.1 서버 응답

```python
response.headers["HX-Trigger"] = json.dumps({
    "showToast": {
        "type": "success",
        "message": "저장되었습니다!"
    },
    "closeModal": True,
})
```

### 8.7.2 클라이언트 처리 (app.js)

```javascript
// HX-Trigger 이벤트 처리
document.addEventListener('htmx:afterRequest', (event) => {
    const triggerHeader = event.detail.xhr.getResponseHeader('HX-Trigger');
    if (triggerHeader) {
        const triggers = JSON.parse(triggerHeader);

        // showToast 트리거 처리
        if (triggers.showToast) {
            htmx.trigger('#toast-container', 'showToast', triggers.showToast);
        }

        // closeModal 트리거 처리
        if (triggers.closeModal) {
            htmx.trigger(document.body, 'closeModal');
        }
    }
});
```

### 8.7.3 흐름 다이어그램

```
┌───────────────────────────────────────────────────────────────────────┐
│                     HTMX 요청 (아이템 생성)                          │
│          hx-post="/partials/items"                                   │
└───────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌───────────────────────────────────────────────────────────────────────┐
│                     서버 처리                                        │
│  1. 아이템 생성                                                      │
│  2. HTML 조각 렌더링                                                 │
│  3. HX-Trigger 헤더 설정                                             │
└───────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌───────────────────────────────────────────────────────────────────────┐
│                     응답                                              │
│  Body: <div id="item-1">...</div>                                    │
│  Header: HX-Trigger: {"showToast": {...}, "closeModal": true}        │
└───────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌───────────────────────────────────────────────────────────────────────┐
│                     클라이언트 처리                                  │
│  1. #items-list에 HTML 삽입 (hx-swap)                                │
│  2. showToast 이벤트 발생 → 토스트 표시                              │
│  3. closeModal 이벤트 발생 → 모달 닫기                               │
└───────────────────────────────────────────────────────────────────────┘
```

---

## 8.8 Form 데이터 수신

### FastAPI Form() 사용

```python
from fastapi import Form

@router.post("", response_class=HTMLResponse)
async def create_item_partial(
    title: str = Form(...),              # 필수
    description: Optional[str] = Form(None),  # 선택적
    priority: int = Form(0),             # 기본값
):
    ...
```

### HTML 폼

```html
<form hx-post="/partials/items"
      hx-target="#items-list"
      hx-swap="afterbegin">
    <input type="text" name="title" required>
    <textarea name="description"></textarea>
    <input type="number" name="priority" value="0">
    <button type="submit">생성</button>
</form>
```

---

## 8.9 파셜 템플릿 예시

### partials/items/form.html

```html
<div class="bg-white rounded-xl shadow-xl max-w-lg w-full" x-data>
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">
            {{ '아이템 수정' if item else '새 아이템' }}
        </h3>
        <button type="button" @click="$dispatch('closeModal')">
            <!-- 닫기 아이콘 -->
        </button>
    </div>

    <!-- Form -->
    <form id="item-form"
          {% if item %}
          hx-put="/partials/items/{{ item.id }}"
          hx-target="#item-{{ item.id }}"
          {% else %}
          hx-post="/partials/items"
          hx-target="#items-list"
          hx-swap="afterbegin"
          {% endif %}
          hx-on::after-request="if(event.detail.successful) $dispatch('closeModal')"
          class="p-4 space-y-4">

        <div>
            <label for="title">제목 <span class="text-red-500">*</span></label>
            <input type="text" id="title" name="title" required
                   value="{{ item.title if item else '' }}">
        </div>

        <!-- 다른 필드들... -->

        <div class="flex justify-end gap-2">
            <button type="button" @click="$dispatch('closeModal')">취소</button>
            <button type="submit">{{ '수정' if item else '생성' }}</button>
        </div>
    </form>
</div>
```
