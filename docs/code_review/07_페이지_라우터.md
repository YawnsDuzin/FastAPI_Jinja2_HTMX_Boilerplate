# 07. 페이지 라우터

## 7.1 개요

페이지 라우터는 **전체 HTML 페이지**를 반환합니다. 브라우저에서 직접 접근하는 URL을 처리하며, `base.html`을 상속받은 완전한 HTML 문서를 응답합니다.

### 관련 파일

- `app/pages/router.py` - 라우터 통합
- `app/pages/home.py` - 홈/소개 페이지
- `app/pages/auth.py` - 로그인/회원가입 페이지
- `app/pages/dashboard.py` - 대시보드/아이템 페이지

### URL 구조

```
/ (루트)
├── /               # 홈페이지
├── /about          # 소개 페이지
│
├── /login          # 로그인 페이지
├── /register       # 회원가입 페이지
├── /forgot-password # 비밀번호 찾기
│
├── /dashboard      # 대시보드 (로그인 필요)
├── /items          # 아이템 목록 (로그인 필요)
├── /profile        # 프로필 (로그인 필요)
└── /settings       # 설정 (로그인 필요)
```

---

## 7.2 홈 페이지 라우터 (app/pages/home.py)

### 7.2.1 홈페이지

```python
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse

from app.api.deps import CurrentUserOptional
from app.core.templates import templates

router = APIRouter()


@router.get("/", response_class=HTMLResponse)
async def home(request: Request, current_user: CurrentUserOptional):
    """홈페이지"""
    return templates.TemplateResponse(
        request=request,
        name="pages/home.html",
        context={
            "title": "홈",
            "current_user": current_user,
        },
    )
```

#### 코드 분석

| 요소 | 설명 |
|------|------|
| `response_class=HTMLResponse` | HTML 응답임을 명시 |
| `Request` | FastAPI Request 객체 (템플릿 렌더링에 필요) |
| `CurrentUserOptional` | 로그인 여부와 관계없이 접근 가능 |
| `templates.TemplateResponse` | Jinja2 템플릿 렌더링 |
| `context` | 템플릿에 전달할 데이터 |

### 7.2.2 소개 페이지

```python
@router.get("/about", response_class=HTMLResponse)
async def about(request: Request, current_user: CurrentUserOptional):
    """소개 페이지"""
    return templates.TemplateResponse(
        request=request,
        name="pages/about.html",
        context={
            "title": "소개",
            "current_user": current_user,
        },
    )
```

---

## 7.3 인증 페이지 라우터 (app/pages/auth.py)

### 7.3.1 로그인 페이지

```python
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse, RedirectResponse

from app.api.deps import CurrentUserOptional
from app.core.templates import templates

router = APIRouter()


@router.get("/login", response_class=HTMLResponse)
async def login_page(request: Request, current_user: CurrentUserOptional):
    """로그인 페이지"""
    # 이미 로그인된 경우 대시보드로 리다이렉트
    if current_user:
        return RedirectResponse(url="/dashboard", status_code=302)

    return templates.TemplateResponse(
        request=request,
        name="pages/login.html",
        context={
            "title": "로그인",
            "current_user": current_user,
        },
    )
```

#### 리다이렉트 로직

```
로그인 페이지 요청 (/login)
        │
        ▼
┌───────────────────────────┐
│ current_user 확인         │
└───────────────────────────┘
        │
        ├── 로그인됨 ──────► RedirectResponse("/dashboard", 302)
        │
        └── 미로그인 ──────► 로그인 페이지 렌더링
```

### 7.3.2 회원가입 페이지

```python
@router.get("/register", response_class=HTMLResponse)
async def register_page(request: Request, current_user: CurrentUserOptional):
    """회원가입 페이지"""
    # 이미 로그인된 경우 대시보드로 리다이렉트
    if current_user:
        return RedirectResponse(url="/dashboard", status_code=302)

    return templates.TemplateResponse(
        request=request,
        name="pages/register.html",
        context={
            "title": "회원가입",
            "current_user": current_user,
        },
    )
```

### 7.3.3 비밀번호 찾기 페이지

```python
@router.get("/forgot-password", response_class=HTMLResponse)
async def forgot_password_page(request: Request, current_user: CurrentUserOptional):
    """비밀번호 찾기 페이지"""
    if current_user:
        return RedirectResponse(url="/dashboard", status_code=302)

    return templates.TemplateResponse(
        request=request,
        name="pages/forgot-password.html",
        context={
            "title": "비밀번호 찾기",
            "current_user": current_user,
        },
    )
```

---

## 7.4 대시보드 라우터 (app/pages/dashboard.py)

### 7.4.1 대시보드 메인

```python
from typing import Annotated, Optional
from fastapi import APIRouter, Depends, Query, Request
from fastapi.responses import HTMLResponse

from app.api.deps import CurrentUser, get_item_service
from app.core.templates import templates
from app.services.item import ItemService

router = APIRouter()


@router.get("/dashboard", response_class=HTMLResponse)
async def dashboard(
    request: Request,
    current_user: CurrentUser,  # 로그인 필수!
    item_service: Annotated[ItemService, Depends(get_item_service)],
):
    """대시보드 메인"""
    # 최근 아이템 조회
    recent_items = await item_service.get_all(
        owner_id=current_user.id,
        limit=5,
    )

    # 통계
    total_items = await item_service.count(owner_id=current_user.id)
    active_items = await item_service.count(owner_id=current_user.id, is_active=True)

    return templates.TemplateResponse(
        request=request,
        name="pages/dashboard.html",
        context={
            "title": "대시보드",
            "current_user": current_user,
            "recent_items": recent_items,
            "stats": {
                "total_items": total_items,
                "active_items": active_items,
            },
        },
    )
```

#### CurrentUser vs CurrentUserOptional

| 의존성 | 미로그인 시 동작 | 사용 페이지 |
|--------|-----------------|-------------|
| `CurrentUserOptional` | `None` 반환 | 홈, 소개, 로그인, 회원가입 |
| `CurrentUser` | 401 에러 (자동 리다이렉트) | 대시보드, 아이템, 프로필 |

### 7.4.2 아이템 목록 페이지

```python
@router.get("/items", response_class=HTMLResponse)
async def items_page(
    request: Request,
    current_user: CurrentUser,
    item_service: Annotated[ItemService, Depends(get_item_service)],
    page: int = Query(1, ge=1),
    search: Optional[str] = None,
):
    """아이템 목록 페이지"""
    page_size = 10
    skip = (page - 1) * page_size

    items = await item_service.get_all(
        owner_id=current_user.id,
        skip=skip,
        limit=page_size,
        search=search,
    )
    total = await item_service.count(owner_id=current_user.id, search=search)
    total_pages = (total + page_size - 1) // page_size

    return templates.TemplateResponse(
        request=request,
        name="pages/items.html",
        context={
            "title": "아이템 관리",
            "current_user": current_user,
            "items": items,
            "page": page,
            "total_pages": total_pages,
            "total": total,
            "search": search,
        },
    )
```

#### 페이지네이션 계산

```python
# 페이지 정보
page_size = 10
skip = (page - 1) * page_size  # 건너뛸 개수
total_pages = (total + page_size - 1) // page_size  # 올림 나눗셈

# 예시: total=25, page_size=10
# total_pages = (25 + 10 - 1) // 10 = 34 // 10 = 3
```

### 7.4.3 프로필/설정 페이지

```python
@router.get("/profile", response_class=HTMLResponse)
async def profile_page(request: Request, current_user: CurrentUser):
    """프로필 페이지"""
    return templates.TemplateResponse(
        request=request,
        name="pages/profile.html",
        context={
            "title": "프로필",
            "current_user": current_user,
        },
    )


@router.get("/settings", response_class=HTMLResponse)
async def settings_page(request: Request, current_user: CurrentUser):
    """설정 페이지"""
    return templates.TemplateResponse(
        request=request,
        name="pages/settings.html",
        context={
            "title": "설정",
            "current_user": current_user,
        },
    )
```

---

## 7.5 라우터 통합 (app/pages/router.py)

```python
from fastapi import APIRouter

from app.pages.auth import router as auth_router
from app.pages.dashboard import router as dashboard_router
from app.pages.home import router as home_router

pages_router = APIRouter()

# 라우터 등록 (prefix 없음)
pages_router.include_router(home_router, tags=["pages"])
pages_router.include_router(auth_router, tags=["pages"])
pages_router.include_router(dashboard_router, tags=["pages"])
```

---

## 7.6 템플릿 렌더링 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                     브라우저 요청: GET /dashboard                   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     FastAPI 라우터 매칭                             │
│                     dashboard.py → dashboard()                      │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     의존성 주입                                     │
│  • CurrentUser: JWT 토큰에서 사용자 정보 추출                       │
│  • ItemService: 아이템 서비스 인스턴스 생성                         │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     비즈니스 로직 실행                              │
│  • item_service.get_all() → 최근 아이템                             │
│  • item_service.count() → 통계 데이터                               │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Jinja2 템플릿 렌더링                            │
│  templates.TemplateResponse(                                        │
│      name="pages/dashboard.html",                                   │
│      context={                                                      │
│          "title": "대시보드",                                       │
│          "current_user": User(...),                                 │
│          "recent_items": [Item(...), ...],                          │
│          "stats": {"total_items": 10, ...}                          │
│      }                                                              │
│  )                                                                  │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     HTML 응답 반환                                  │
│  <!DOCTYPE html>                                                    │
│  <html>                                                             │
│    <head>...</head>                                                 │
│    <body>                                                           │
│      <nav>...</nav>  <!-- 네비게이션 -->                            │
│      <main>          <!-- 대시보드 컨텐츠 -->                       │
│        ...                                                          │
│      </main>                                                        │
│    </body>                                                          │
│  </html>                                                            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 7.7 템플릿 컨텍스트 변수

### 7.7.1 필수 변수

| 변수 | 타입 | 설명 |
|------|------|------|
| `request` | `Request` | FastAPI Request 객체 (템플릿 필수) |
| `title` | `str` | 페이지 제목 |
| `current_user` | `User \| None` | 현재 로그인한 사용자 |

### 7.7.2 전역 변수 (templates.py에서 설정)

```python
# app/core/templates.py
templates.env.globals["app_name"] = settings.app_name
templates.env.globals["debug"] = settings.debug
templates.env.globals["now"] = datetime.now
```

### 7.7.3 템플릿에서 사용

```html
<!-- 페이지 제목 -->
<title>{{ title }} | {{ app_name }}</title>

<!-- 조건부 렌더링 -->
{% if current_user %}
    <span>안녕하세요, {{ current_user.username }}님!</span>
{% else %}
    <a href="/login">로그인</a>
{% endif %}

<!-- 데이터 반복 -->
{% for item in recent_items %}
    <li>{{ item.title }}</li>
{% endfor %}
```

---

## 7.8 에러 페이지 처리

`app/core/exceptions.py`에서 에러 페이지 렌더링:

```python
@app.exception_handler(404)
async def not_found_handler(request: Request, exc):
    # API 요청은 JSON 응답
    if request.url.path.startswith("/api"):
        return JSONResponse(
            status_code=404,
            content={"error": True, "message": "리소스를 찾을 수 없습니다."},
        )

    # 페이지 요청은 404 페이지 렌더링
    return templates.TemplateResponse(
        request=request,
        name="pages/404.html",
        status_code=404,
    )
```
