# 11. 프론트엔드 JavaScript

## 11.1 개요

이 프로젝트는 **HTMX**와 **Alpine.js**를 사용하여 최소한의 JavaScript만 작성합니다. 대부분의 동적 기능은 HTML 속성으로 처리됩니다.

### 관련 파일

- `static/js/app.js` - 메인 JavaScript
- `static/css/custom.css` - 커스텀 CSS

### 프론트엔드 기술 스택

| 기술 | 용도 | 크기 |
|------|------|------|
| **HTMX** | HTML 기반 AJAX | ~14KB |
| **Alpine.js** | 반응형 UI 컴포넌트 | ~15KB |
| **TailwindCSS** | 유틸리티 CSS | CDN |

---

## 11.2 메인 JavaScript (static/js/app.js)

### 11.2.1 토스트 핸들러

```javascript
// 전역으로 정의 (hx-boost 후에도 사용 가능)
window.toastHandler = function toastHandler() {
    return {
        // 토스트 배열 (Alpine.js 반응형)
        toasts: [],

        // 토스트 표시
        show(detail) {
            const toast = {
                id: Date.now(),                    // 고유 ID
                type: detail.type || 'info',       // success, error, warning, info
                message: detail.message || '알림', // 메시지
            };

            this.toasts.push(toast);

            // 5초 후 자동 제거
            setTimeout(() => {
                this.remove(toast.id);
            }, 5000);
        },

        // 토스트 제거
        remove(id) {
            this.toasts = this.toasts.filter(t => t.id !== id);
        }
    };
};
```

#### 토스트 사용 방법

```javascript
// JavaScript에서 직접 호출
window.dispatchEvent(new CustomEvent('showToast', {
    detail: { type: 'success', message: '저장되었습니다!' }
}));

// HTMX 서버 응답 헤더로 트리거
// HX-Trigger: {"showToast": {"type": "success", "message": "저장!"}}
```

### 11.2.2 Alpine.js 재초기화

```javascript
// HTMX가 콘텐츠를 교체하면 Alpine.js 컴포넌트가 초기화되지 않은 상태
// 이 함수로 재초기화 수행
function reinitializeAlpine(target) {
    if (typeof Alpine !== 'undefined' && Alpine.initTree) {
        // DOM이 완전히 업데이트된 후 Alpine 초기화
        requestAnimationFrame(() => {
            try {
                Alpine.initTree(target || document.body);
            } catch (e) {
                console.warn('Alpine.initTree error:', e);
            }
        });
    }
}
```

### 11.2.3 HTMX 이벤트 핸들러

```javascript
// 핸들러 중복 등록 방지
if (!window.__htmxHandlersRegistered) {
    window.__htmxHandlersRegistered = true;

    // 콘텐츠 교체 후 Alpine.js 재초기화
    document.addEventListener('htmx:afterSwap', (event) => {
        reinitializeAlpine(event.detail.target);
    });

    document.addEventListener('htmx:afterSettle', (event) => {
        reinitializeAlpine(event.detail.target);
    });

    document.addEventListener('htmx:load', (event) => {
        reinitializeAlpine(event.detail.elt);
    });

    // 에러 핸들링
    document.addEventListener('htmx:responseError', (event) => {
        console.error('HTMX Error:', event.detail);

        // 401 에러 → 로그인 페이지로 리다이렉트
        if (event.detail.xhr && event.detail.xhr.status === 401) {
            window.location.href = '/login';
        }

        // 토스트로 에러 메시지 표시
        const errorMessage = event.detail.xhr?.responseText || '오류가 발생했습니다.';
        htmx.trigger('#toast-container', 'showToast', {
            type: 'error',
            message: errorMessage
        });
    });
}
```

### 11.2.4 HX-Trigger 처리

```javascript
// 서버 응답의 HX-Trigger 헤더 처리
document.addEventListener('htmx:afterRequest', (event) => {
    if (!event.detail.xhr) return;

    const triggerHeader = event.detail.xhr.getResponseHeader('HX-Trigger');
    if (triggerHeader) {
        try {
            const triggers = JSON.parse(triggerHeader);

            // showToast 트리거
            if (triggers.showToast) {
                htmx.trigger('#toast-container', 'showToast', triggers.showToast);
            }

            // closeModal 트리거
            if (triggers.closeModal) {
                htmx.trigger(document.body, 'closeModal');
            }

            // refreshList 트리거
            if (triggers.refreshList) {
                htmx.trigger('#items-list', 'refresh');
            }
        } catch (e) {
            // 단순 문자열 트리거 - 무시
        }
    }
});
```

### 11.2.5 다크모드 초기화

```javascript
(function () {
    // 시스템 설정 확인
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const storedMode = localStorage.getItem('darkMode');

    // 저장된 설정 우선, 없으면 시스템 설정 사용
    if (storedMode === 'true' || (storedMode === null && prefersDark)) {
        document.documentElement.classList.add('dark');
    }
})();
```

### 11.2.6 유틸리티 함수

```javascript
window.Utils = {
    // 디바운스: 연속 호출 중 마지막만 실행
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    // 쓰로틀: 일정 간격으로만 실행
    throttle(func, limit) {
        let inThrottle;
        return function executedFunction(...args) {
            if (!inThrottle) {
                func(...args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    },

    // 날짜 포맷팅
    formatDate(date, format = 'YYYY-MM-DD') {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');

        return format
            .replace('YYYY', year)
            .replace('MM', month)
            .replace('DD', day)
            .replace('HH', hours)
            .replace('mm', minutes);
    },

    // 클립보드 복사
    async copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            return true;
        } catch (err) {
            console.error('클립보드 복사 실패:', err);
            return false;
        }
    }
};
```

### 11.2.7 모달 닫기 함수

```javascript
// Alpine.js 이벤트로 모달 닫기
// base.html의 @closeModal.window="open = false"가 수신
window.closeModal = function() {
    window.dispatchEvent(new CustomEvent('closeModal'));
};
```

---

## 11.3 커스텀 CSS (static/css/custom.css)

### 11.3.1 Alpine.js x-cloak

```css
/* Alpine.js 초기화 전 깜빡임 방지 */
[x-cloak] {
    display: none !important;
}
```

### 11.3.2 HTMX 로딩 인디케이터

```css
/* 기본: 숨김 */
.htmx-indicator {
    opacity: 0;
    transition: opacity 200ms ease-in-out;
    pointer-events: none;
}

/* 요청 중: 표시 */
.htmx-request .htmx-indicator,
.htmx-request.htmx-indicator {
    opacity: 1;
}

/* 상단 로딩 바 */
#loading-indicator {
    transform: scaleX(0);
    transform-origin: left;
    transition: none;
}

.htmx-request #loading-indicator,
body.htmx-request #loading-indicator {
    transform: scaleX(1);
    animation: loading-bar 2s ease-in-out infinite;
}

@keyframes loading-bar {
    0% { transform: scaleX(0); transform-origin: left; }
    50% { transform: scaleX(1); transform-origin: left; }
    50.01% { transform: scaleX(1); transform-origin: right; }
    100% { transform: scaleX(0); transform-origin: right; }
}
```

### 11.3.3 HTMX 전환 애니메이션

```css
/* 스와핑 중: 페이드 아웃 */
.htmx-swapping {
    opacity: 0;
    transition: opacity 150ms ease-out;
}

/* 세틀링 중: 페이드 인 */
.htmx-settling {
    opacity: 1;
    transition: opacity 150ms ease-in;
}

/* 새로 추가된 요소: 슬라이드 인 */
.htmx-added {
    animation: fade-slide-in 200ms ease-out;
}

@keyframes fade-slide-in {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
```

### 11.3.4 버튼 로딩 스피너

```css
/* 버튼 내부 로딩 상태 */
.btn-loading {
    position: relative;
    color: transparent !important;  /* 텍스트 숨김 */
    pointer-events: none;           /* 클릭 비활성화 */
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 1rem;
    height: 1rem;
    top: 50%;
    left: 50%;
    margin-left: -0.5rem;
    margin-top: -0.5rem;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
```

### 11.3.5 토스트 애니메이션

```css
/* 오른쪽에서 슬라이드 인 */
@keyframes slide-in-right {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* 오른쪽으로 슬라이드 아웃 */
@keyframes slide-out-right {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

.toast-enter { animation: slide-in-right 300ms ease-out; }
.toast-leave { animation: slide-out-right 200ms ease-in forwards; }

/* 토스트 프로그레스 바 */
.toast-progress {
    animation: toast-countdown linear forwards;
}

@keyframes toast-countdown {
    from { width: 100%; }
    to { width: 0%; }
}
```

### 11.3.6 스켈레톤 로딩

```css
/* 콘텐츠 로드 전 플레이스홀더 */
.skeleton {
    background: linear-gradient(
        90deg,
        #e2e8f0 0%,
        #f1f5f9 50%,
        #e2e8f0 100%
    );
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s ease-in-out infinite;
}

/* 다크모드 */
.dark .skeleton {
    background: linear-gradient(
        90deg,
        #374151 0%,
        #4b5563 50%,
        #374151 100%
    );
    background-size: 200% 100%;
}

@keyframes skeleton-shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
```

**사용 예시:**
```html
<!-- 로딩 중 플레이스홀더 -->
<div class="skeleton h-4 w-full rounded mb-2"></div>
<div class="skeleton h-4 w-3/4 rounded"></div>
```

### 11.3.7 커스텀 스크롤바

```css
/* WebKit 브라우저 (Chrome, Safari, Edge) */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* 다크모드 */
.dark ::-webkit-scrollbar-thumb {
    background: #475569;
}

/* Firefox */
* {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}
```

### 11.3.8 텍스트 줄 제한

```css
.line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-2 { -webkit-line-clamp: 2; /* ... */ }
.line-clamp-3 { -webkit-line-clamp: 3; /* ... */ }
```

### 11.3.9 접근성

```css
/* 포커스 가시성 향상 */
:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

/* 모션 감소 설정 존중 */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }

    .htmx-swapping,
    .htmx-settling,
    .htmx-added {
        transition: none !important;
        animation: none !important;
    }
}
```

### 11.3.10 프린트 스타일

```css
@media print {
    .no-print,
    #toast-container,
    #modal-container,
    #loading-indicator,
    #global-spinner {
        display: none !important;
    }

    body {
        background: white !important;
        color: black !important;
    }
}
```

---

## 11.4 HTMX 이벤트 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│ 1. 사용자 액션 (클릭, 입력 등)                                       │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 2. htmx:configRequest - 요청 설정                                    │
│    • 헤더 추가                                                       │
│    • 파라미터 수정                                                   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 3. htmx:beforeRequest - 요청 전                                      │
│    • 로딩 인디케이터 표시 (.htmx-request 클래스 추가)                │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 4. AJAX 요청 전송                                                    │
│    GET/POST/PUT/DELETE → 서버                                        │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 5. 서버 응답                                                         │
│    • HTML 조각                                                       │
│    • HX-Trigger 헤더                                                 │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 6. htmx:beforeSwap - 스왑 전                                         │
│    • .htmx-swapping 클래스 추가                                      │
│    • 기존 콘텐츠 페이드 아웃                                         │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 7. htmx:afterSwap - 스왑 후                                          │
│    • 새 콘텐츠 DOM에 삽입                                            │
│    • Alpine.js 재초기화                                              │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 8. htmx:afterSettle - 세틀 후                                        │
│    • .htmx-settling 클래스 추가                                      │
│    • 새 콘텐츠 페이드 인                                             │
│    • 로딩 인디케이터 숨김                                            │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 9. htmx:afterRequest - 요청 완료                                     │
│    • HX-Trigger 헤더 처리                                            │
│    • 토스트 표시, 모달 닫기 등                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 11.5 Alpine.js 주요 디렉티브

### 11.5.1 데이터 바인딩

| 디렉티브 | 설명 | 예시 |
|----------|------|------|
| `x-data` | 컴포넌트 상태 정의 | `x-data="{ open: false }"` |
| `x-text` | 텍스트 바인딩 | `x-text="message"` |
| `x-html` | HTML 바인딩 | `x-html="content"` |
| `x-model` | 양방향 바인딩 | `x-model="search"` |
| `x-bind:속성` | 속성 바인딩 | `:class="{ active: isActive }"` |

### 11.5.2 조건부 렌더링

| 디렉티브 | 설명 | 예시 |
|----------|------|------|
| `x-show` | display로 토글 | `x-show="open"` |
| `x-if` | DOM에서 제거/추가 | `<template x-if="show">` |
| `x-cloak` | 초기 깜빡임 방지 | `x-cloak` |

### 11.5.3 이벤트 핸들링

| 디렉티브 | 설명 | 예시 |
|----------|------|------|
| `@click` | 클릭 이벤트 | `@click="open = !open"` |
| `@submit.prevent` | 폼 제출 (기본 동작 방지) | `@submit.prevent="save()"` |
| `@keydown.escape` | ESC 키 | `@keydown.escape="close()"` |
| `$dispatch` | 커스텀 이벤트 발생 | `$dispatch('openModal')` |

### 11.5.4 트랜지션

```html
<div x-show="open"
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0 scale-95"
     x-transition:enter-end="opacity-100 scale-100"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100 scale-100"
     x-transition:leave-end="opacity-0 scale-95">
    <!-- 콘텐츠 -->
</div>
```

---

## 11.6 HTMX와 Alpine.js 통합 패턴

### 11.6.1 모달 열기/닫기

```html
<!-- 모달 열기 버튼 -->
<button hx-get="/partials/items/create"
        hx-target="#modal-content"
        @click="$dispatch('openModal')">
    새 아이템
</button>

<!-- 모달 닫기 버튼 -->
<button @click="$dispatch('closeModal')">
    취소
</button>

<!-- 서버에서 모달 닫기 -->
<!-- Python: response.headers["HX-Trigger"] = '{"closeModal": true}' -->
```

### 11.6.2 토스트 표시

```python
# 서버 (Python)
response.headers["HX-Trigger"] = json.dumps({
    "showToast": {
        "type": "success",
        "message": "저장되었습니다!"
    }
})
```

```javascript
// 클라이언트 (JavaScript)
window.dispatchEvent(new CustomEvent('showToast', {
    detail: { type: 'error', message: '오류 발생!' }
}));
```

### 11.6.3 폼 제출 후 목록 갱신

```html
<form hx-post="/partials/items"
      hx-target="#items-list"
      hx-swap="innerHTML">
    <!-- 폼 필드 -->
    <button type="submit">저장</button>
</form>
```

```python
# 서버 응답
response.headers["HX-Trigger"] = json.dumps({
    "showToast": {"type": "success", "message": "저장 완료"},
    "closeModal": True
})
return templates.TemplateResponse("partials/items/list.html", ...)
```

