"""
FastAPI Application Entry Point
FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ì§„ì…ì 

ì´ íŒŒì¼ì€ FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‹œì‘ì ì…ë‹ˆë‹¤.
ì›¹ ì„œë²„(uvicorn)ê°€ ì´ íŒŒì¼ì˜ 'app' ê°ì²´ë¥¼ ë¡œë“œí•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤.

ì‹¤í–‰ ë°©ë²•:
    uvicorn app.main:app --reload

ì£¼ìš” ì—­í• :
    1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    2. ë¯¸ë“¤ì›¨ì–´ ì„¤ì • (CORS, ì¸ì¦ ë“±)
    3. ë¼ìš°í„° ë“±ë¡ (API, í˜ì´ì§€, íŒŒì…œ)
    4. ì •ì  íŒŒì¼ ì„œë¹™ ì„¤ì •
    5. ìˆ˜ëª…ì£¼ê¸°(lifespan) ê´€ë¦¬ (DB ì—°ê²° ë“±)
"""

from contextlib import asynccontextmanager
from typing import AsyncGenerator

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles

from app.api.v1.router import api_router
from app.config import settings
from app.core.exceptions import setup_exception_handlers
from app.core.templates import templates
from app.database import close_db, init_db
from app.pages.router import pages_router
from app.partials.router import partials_router


# =============================================================================
# ìˆ˜ëª…ì£¼ê¸°(Lifespan) ê´€ë¦¬
# =============================================================================
# FastAPIì˜ lifespanì€ ì•± ì‹œì‘/ì¢…ë£Œ ì‹œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
# - ì‹œì‘ ì‹œ: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, ìºì‹œ ì´ˆê¸°í™”, ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ê²° ë“±
# - ì¢…ë£Œ ì‹œ: ì—°ê²° ì •ë¦¬, ë¦¬ì†ŒìŠ¤ í•´ì œ ë“±
#
# @asynccontextmanager ë°ì½”ë ˆì´í„°:
# - 'yield' ì´ì „ ì½”ë“œ: ì•± ì‹œì‘ ì‹œ ì‹¤í–‰ (startup)
# - 'yield' ì´í›„ ì½”ë“œ: ì•± ì¢…ë£Œ ì‹œ ì‹¤í–‰ (shutdown)
# =============================================================================


@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncGenerator:
    """
    ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ëª…ì£¼ê¸° ê´€ë¦¬

    ì‹œì‘ ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”, ì¢…ë£Œ ì‹œ ì—°ê²° ì •ë¦¬ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.

    íë¦„:
        1. ì„œë²„ ì‹œì‘ â†’ init_db() ì‹¤í–‰ â†’ DB í…Œì´ë¸” ìƒì„±
        2. yield â†’ ì•±ì´ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë™ì•ˆ ëŒ€ê¸°
        3. ì„œë²„ ì¢…ë£Œ ì‹ í˜¸ â†’ close_db() ì‹¤í–‰ â†’ DB ì—°ê²° ì •ë¦¬

    Note:
        ì´ì „ ë²„ì „ì˜ @app.on_event("startup")/@app.on_event("shutdown") ë°©ì‹ì€
        deprecated ë˜ì—ˆìœ¼ë©°, lifespan ë°©ì‹ì´ ê¶Œì¥ë©ë‹ˆë‹¤.
    """
    # =========================================================================
    # Startup (ì•± ì‹œì‘ ì‹œ ì‹¤í–‰)
    # =========================================================================
    print("ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì¤‘...")
    await init_db()  # DB ì—”ì§„ ìƒì„± ë° í…Œì´ë¸” ì´ˆê¸°í™”
    print("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ")

    yield  # ì•±ì´ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆ ì—¬ê¸°ì„œ ëŒ€ê¸°

    # =========================================================================
    # Shutdown (ì•± ì¢…ë£Œ ì‹œ ì‹¤í–‰)
    # =========================================================================
    print("ğŸ›‘ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì¤‘...")
    await close_db()  # DB ì—°ê²° í’€ ì •ë¦¬
    print("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ ì™„ë£Œ")


# =============================================================================
# ì• í”Œë¦¬ì¼€ì´ì…˜ íŒ©í† ë¦¬ íŒ¨í„´
# =============================================================================
# íŒ©í† ë¦¬ íŒ¨í„´ì„ ì‚¬ìš©í•˜ë©´:
# - í…ŒìŠ¤íŠ¸ ì‹œ ë‹¤ë¥¸ ì„¤ì •ìœ¼ë¡œ ì•±ì„ ìƒì„±í•  ìˆ˜ ìˆìŒ
# - ì—¬ëŸ¬ ì•± ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŒ
# - ì„¤ì •ì„ ì£¼ì…ë°›ì•„ ìœ ì—°í•˜ê²Œ ì•±ì„ êµ¬ì„±í•  ìˆ˜ ìˆìŒ
# =============================================================================


def create_app() -> FastAPI:
    """
    FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ íŒ©í† ë¦¬

    ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìƒì„±í•˜ê³  í•„ìš”í•œ ì„¤ì •ì„ ì ìš©í•©ë‹ˆë‹¤.

    Returns:
        ì„¤ì •ì´ ì™„ë£Œëœ FastAPI ì¸ìŠ¤í„´ìŠ¤

    êµ¬ì„± ìš”ì†Œ:
        1. FastAPI ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ì œëª©, ë²„ì „, API ë¬¸ì„œ ì„¤ì •)
        2. CORS ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€
        3. ì •ì  íŒŒì¼ ë§ˆìš´íŠ¸
        4. ì˜ˆì™¸ í•¸ë“¤ëŸ¬ ë“±ë¡
        5. ë¼ìš°í„° ë“±ë¡ (API, í˜ì´ì§€, íŒŒì…œ)
    """

    # =========================================================================
    # FastAPI ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    # =========================================================================
    app = FastAPI(
        title=settings.app_name,                                    # API ë¬¸ì„œì— í‘œì‹œë  ì œëª©
        description="FastAPI + Jinja2 + HTMX Boilerplate",          # API ì„¤ëª…
        version="1.0.0",                                            # API ë²„ì „
        # ê°œë°œ ëª¨ë“œì—ì„œë§Œ API ë¬¸ì„œ í™œì„±í™” (ë³´ì•ˆ)
        docs_url="/docs" if settings.debug else None,               # Swagger UI
        redoc_url="/redoc" if settings.debug else None,             # ReDoc
        openapi_url="/openapi.json" if settings.debug else None,    # OpenAPI ìŠ¤í‚¤ë§ˆ
        lifespan=lifespan,                                          # ìˆ˜ëª…ì£¼ê¸° ê´€ë¦¬ì
    )

    # =========================================================================
    # CORS (Cross-Origin Resource Sharing) ë¯¸ë“¤ì›¨ì–´
    # =========================================================================
    # CORSëŠ” ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œ ì´ APIì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.
    # ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ(localhost:3000)ì—ì„œ ë°±ì—”ë“œ(localhost:8000) API í˜¸ì¶œ
    #
    # allow_origins: í—ˆìš©í•  ë„ë©”ì¸ ëª©ë¡ (ì˜ˆ: ["http://localhost:3000"])
    # allow_credentials: ì¿ í‚¤ ì „ì†¡ í—ˆìš© ì—¬ë¶€ (JWT ì¿ í‚¤ ì¸ì¦ì— í•„ìš”)
    # allow_methods: í—ˆìš©í•  HTTP ë©”ì„œë“œ (GET, POST, PUT, DELETE ë“±)
    # allow_headers: í—ˆìš©í•  HTTP í—¤ë”
    # =========================================================================
    app.add_middleware(
        CORSMiddleware,
        allow_origins=settings.cors_origins,  # ì„¤ì • íŒŒì¼ì—ì„œ í—ˆìš© ë„ë©”ì¸ ë¡œë“œ
        allow_credentials=True,               # ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ ì‚¬ìš©ì„ ìœ„í•´ True
        allow_methods=["*"],                  # ëª¨ë“  HTTP ë©”ì„œë“œ í—ˆìš©
        allow_headers=["*"],                  # ëª¨ë“  í—¤ë” í—ˆìš©
    )

    # =========================================================================
    # ì •ì  íŒŒì¼ ë§ˆìš´íŠ¸
    # =========================================================================
    # /static ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ static/ ë””ë ‰í† ë¦¬ì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    # ì˜ˆ: /static/css/custom.css â†’ static/css/custom.css íŒŒì¼ ë°˜í™˜
    # =========================================================================
    app.mount("/static", StaticFiles(directory="static"), name="static")

    # =========================================================================
    # ì˜ˆì™¸ í•¸ë“¤ëŸ¬ ì„¤ì •
    # =========================================================================
    # ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë¥¼ ì¼ê´€ëœ í˜•ì‹ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    # - 404 Not Found â†’ 404 í˜ì´ì§€ ë Œë”ë§
    # - 500 Internal Server Error â†’ 500 í˜ì´ì§€ ë Œë”ë§
    # - ì»¤ìŠ¤í…€ ì˜ˆì™¸ â†’ ì ì ˆí•œ ì—ëŸ¬ ì‘ë‹µ ë°˜í™˜
    # =========================================================================
    setup_exception_handlers(app)

    # =========================================================================
    # ë¼ìš°í„° ë“±ë¡
    # =========================================================================
    # FastAPIì—ì„œ ë¼ìš°í„°ëŠ” URL ê²½ë¡œì™€ ì²˜ë¦¬ í•¨ìˆ˜ë¥¼ ë§¤í•‘í•©ë‹ˆë‹¤.
    #
    # ì´ ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ëŠ” 3ê°€ì§€ ìœ í˜•ì˜ ë¼ìš°í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:
    #
    # 1. API ë¼ìš°í„° (/api/v1/*)
    #    - JSON ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ” REST API
    #    - ì˜ˆ: /api/v1/auth/login, /api/v1/items
    #
    # 2. í˜ì´ì§€ ë¼ìš°í„° (/)
    #    - HTML í˜ì´ì§€ë¥¼ ë°˜í™˜í•˜ëŠ” ë¼ìš°í„°
    #    - ì˜ˆ: /, /login, /dashboard
    #
    # 3. íŒŒì…œ ë¼ìš°í„° (/partials/*)
    #    - HTMX ìš”ì²­ì— ëŒ€í•´ ë¶€ë¶„ HTMLì„ ë°˜í™˜
    #    - ì „ì²´ í˜ì´ì§€ê°€ ì•„ë‹Œ íŠ¹ì • ì˜ì—­ë§Œ ì—…ë°ì´íŠ¸
    #    - ì˜ˆ: /partials/items/list, /partials/toasts/success
    # =========================================================================

    # API ë¼ìš°í„°: /api/v1 í”„ë¦¬í”½ìŠ¤ë¡œ ë“±ë¡
    app.include_router(api_router, prefix="/api/v1")

    # í˜ì´ì§€ ë¼ìš°í„°: í”„ë¦¬í”½ìŠ¤ ì—†ì´ ë£¨íŠ¸ì— ë“±ë¡
    app.include_router(pages_router)

    # íŒŒì…œ ë¼ìš°í„°: /partials í”„ë¦¬í”½ìŠ¤ë¡œ ë“±ë¡
    app.include_router(partials_router, prefix="/partials")

    return app


# =============================================================================
# ì•± ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
# =============================================================================
# ì´ ë³€ìˆ˜ê°€ uvicornì´ ì°¾ëŠ” ì§„ì…ì ì…ë‹ˆë‹¤.
# uvicorn app.main:app ëª…ë ¹ì—ì„œ 'app'ì´ ë°”ë¡œ ì´ ë³€ìˆ˜ì…ë‹ˆë‹¤.
# =============================================================================
app = create_app()


# =============================================================================
# í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
# =============================================================================
# ì„œë²„ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ì…ë‹ˆë‹¤.
#
# ì‚¬ìš©ì²˜:
# - ë¡œë“œë°¸ëŸ°ì„œì˜ í—¬ìŠ¤ ì²´í¬
# - ì¿ ë²„ë„¤í‹°ìŠ¤ liveness/readiness probe
# - ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
#
# ì‘ë‹µ ì˜ˆì‹œ: {"status": "healthy", "app": "FastAPI Boilerplate"}
# =============================================================================


@app.get("/health", tags=["health"])
async def health_check():
    """
    í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸

    ì„œë²„ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    ë°°í¬ í™˜ê²½ì—ì„œ ë¡œë“œë°¸ëŸ°ì„œë‚˜ ëª¨ë‹ˆí„°ë§ ë„êµ¬ê°€ ì´ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.

    Returns:
        dict: ì„œë²„ ìƒíƒœ ì •ë³´
            - status: "healthy" (ì •ìƒ)
            - app: ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„
    """
    return {"status": "healthy", "app": settings.app_name}
